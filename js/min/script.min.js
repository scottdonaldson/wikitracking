!function(){function e(e){function t(e){e.forEach(function(e){var t=new Date(e.timestamp).getFullYear();h[t]?h[t]++:h[t]=1})}function i(e,t){return d3.scale.linear().domain(e).range(t)}function l(e){return d3.min([s+o-5,s+o-m(e.value)])}function u(e){return d3.max([5,m(e.value)])}function d(){p=a.selectAll("rect").data(d3.entries(h)),p.reverse().enter().append("rect"),p.transition().duration(250).each("start",function(){d3.select(this).attr("fill","#333")}).each("end",function(){d3.select(this).attr("fill","#000")}).attr("x",function(e,t){return 20+s+t*(r/d3.entries(h).length)}).attr("y",l).attr("width",r/d3.entries(h).length-c).attr("height",u),p.exit().remove(),p.on("mouseover",function(e){var t=d3.select(this);p.each(function(){d3.select(this).style({fill:"#000"})}),t.style({fill:"#f70"}),d3.select("#modal").style({display:"block",left:+t.attr("x")-100+.5*+t.attr("width")+"px",top:.5*(o+ +t.attr("y"))+"px"}).select("[data-edits]").html(e.key+"<br>"+e.value+"&nbsp;edits")})}var m,v,f,p,g=[],h={};return{getRevisions:function y(r,c){if(localStorage.getItem("wikitracking-"+e))g=JSON.parse(localStorage.getItem("wikitracking-"+e)),t(g),m=i([8,d3.max(d3.values(h))],[0,o]),v=i([8,d3.max(d3.values(h))],[o+s,s]),f.scale(v),a.select(".y.axis").transition().call(f),d();else{r||(r=""),c||(c="");var l="http://en.wikipedia.org/w/api.php?action=query&format=json&prop=revisions&titles="+e+"&rvprop=timestamp|user&continue="+r+"&rvlimit=500"+(c?"&rvcontinue="+c:"");n.get(l,function(e){for(var n in e.query.pages)g=g.concat(e.query.pages[n].revisions),t(e.query.pages[n].revisions);e["continue"]&&(y(e["continue"]?e["continue"]["continue"]:"",e["continue"]?e["continue"].rvcontinue:""),m=i([8,d3.max(d3.values(h))],[0,o]),v=i([8,d3.max(d3.values(h))],[o+s,s]),f.scale(v),a.select(".y.axis").transition().call(f),d())})}return this},makeGraph:function(){return a.attr("width",r+2*s).attr("height",o+2*s),m=i([8,d3.max(d3.values(h))],[0,o]),v=i([8,d3.max(d3.values(h))],[o+s,s]),f=d3.svg.axis().scale(v).orient("left").ticks(5),a.append("g").attr("class","y axis").attr("transform","translate("+s+",0)").call(f),this},archive:function(){localStorage.setItem("wikitracking-"+e,JSON.stringify(g))}}}function t(){var e=this.value,t="http://en.wikipedia.org/w/api.php?action=opensearch&format=json&search="+e+"&limit=10";n.get(t,function(e){for(;v.firstChild;)v.removeChild(v.firstChild);e[1].forEach(function(t,n){var i=document.createElement("p"),a=document.createElement("small");i.setAttribute("data-suggestion",t),i.innerHTML+=t,a.innerHTML+=e[2][n],i.appendChild(a),v.appendChild(i)})})}var n=function(){var e={};return e.get=function(e,t){e+="&callback=_dummy";var n=window.setTimeout(function(){window.dummy=function(){},on_timeout()},1e3);window._dummy=function(e){window.clearTimeout(n),t(e)};var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src=e,document.getElementsByTagName("head")[0].appendChild(i)},e}(),i=!1,a=d3.select("#main").append("svg"),r=800,o=500,s=80,c=5,l=new Date,u=l.getFullYear(),d=(l.getMonth()+1,l.getDate(),l.getHours(),[31,28,31,30,31,30,31,31,30,31,30,31]);u%4===0&&2100!==u&&(d[1]=29);var m=document.getElementById("query");document.getElementById("submit").addEventListener("click",function(t){t.preventDefault(),i&&i.archive(),i=new e(encodeURIComponent(m.value)).makeGraph().getRevisions()});var v=document.getElementById("suggestions");v.addEventListener("click",function(t){for(var n=t.target;n!==v&&!n.hasAttribute("data-suggestion");)return n=n.parentNode,!1;for(;v.firstChild;)v.removeChild(v.firstChild);m.value="",i&&i.archive(),i=new e(encodeURIComponent(n.getAttribute("data-suggestion"))).makeGraph().getRevisions()}),m.addEventListener("keyup",t,!1)}();